#!/bin/bash

KVER="__KVER__"
KVER=$(echo $KVER | tr '~' '-')
export KVER

! test -e /etc/ld.so.preload || sed -i '/libarmmem.so/d' /etc/ld.so.preload

if [ $1 == "install" -o $1 == "upgrade" ]; then

        mkdir -p /usr/local/sbin
        test -x /usr/local/sbin/xbian-arch || { echo "echo iMX6" > /usr/local/sbin/xbian-arch && chmod +x /usr/local/sbin/xbian-arch; }

        INITRD=No run-parts --new-session --report -a $KVER /etc/kernel/preinst.d/ > /dev/null 2>&1
        mountpoint -q /boot || mount /boot || :

        [ -d /lib/modules/$KVER.xbian ] && rm -fr /lib/modules/$KVER.xbian
        [ -d /lib/modules/$KVER ] && mv /lib/modules/$KVER /lib/modules/$KVER.xbian || true
        [ -d /lib/modules/$KVER.xbian/extra ] && { mkdir -p /lib/modules/$KVER; mv /lib/modules/$KVER.xbian/extra /lib/modules/$KVER; } || :

        [ -e /boot/boot.scr.txt.xbian ] && cp /boot/boot.scr.txt.xbian /boot/boot.scr.txt.user
        [ -e /boot/boot.scr.txt ] && cp /boot/boot.scr.txt /boot/boot.scr.txt.user

fi

exit 0
